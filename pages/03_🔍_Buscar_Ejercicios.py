"""
B√∫squeda de Ejercicios con Selecci√≥n para Documentos
P√°gina: 03_üîç_Buscar_Ejercicios.py
"""

import streamlit as st
import pandas as pd
from datetime import datetime

# Importar dependencias
try:
    from database.db_manager import DatabaseManager
except ImportError:
    import sys
    sys.path.append('.')
    from database.db_manager import DatabaseManager

def main():
    st.set_page_config(
        page_title="Buscar Ejercicios",
        page_icon="üîç",
        layout="wide"
    )
    
    st.markdown("""
    <div style="background: linear-gradient(90deg, #1f4e79 0%, #2e5984 100%); color: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 2rem;">
        <h1>üîç Buscar y Seleccionar Ejercicios</h1>
        <p>Busca ejercicios y selecciona los que quieres incluir en tus documentos</p>
    </div>
    """, unsafe_allow_html=True)
    
    try:
        db = DatabaseManager()
        
        # Inicializar session state para ejercicios seleccionados
        if 'ejercicios_seleccionados' not in st.session_state:
            st.session_state.ejercicios_seleccionados = []
        
        # SIDEBAR CON FILTROS
        with st.sidebar:
            st.header("üîç Filtros de B√∫squeda")
            
            # Obtener datos para filtros
            ejercicios = db.obtener_ejercicios()
            unidades = db.obtener_unidades_tematicas()
            
            # Filtros
            unidades_filtro = st.multiselect(
                "üéØ Unidades Tem√°ticas",
                unidades,
                default=[],
                help="Selecciona unidades espec√≠ficas o deja vac√≠o para todas"
            )
            
            dificultades_filtro = st.multiselect(
                "üéöÔ∏è Nivel de Dificultad",
                ["B√°sico", "Intermedio", "Avanzado", "Desaf√≠o"],
                default=[],
                help="Selecciona niveles espec√≠ficos o deja vac√≠o para todos"
            )
            
            modalidades_filtro = st.multiselect(
                "üíª Modalidad",
                ["Te√≥rico", "Computacional", "Mixto"],
                default=[],
                help="Selecciona modalidades espec√≠ficas"
            )
            
            # B√∫squeda por texto
            texto_busqueda = st.text_input(
                "üîé Buscar en t√≠tulo/contenido",
                placeholder="Ej: convoluci√≥n, fourier, laplace..."
            )
            
            st.divider()
            
            # CARRITO DE SELECCI√ìN
            st.header("üõí Ejercicios Seleccionados")
            st.write(f"**Total:** {len(st.session_state.ejercicios_seleccionados)}")
            
            if st.session_state.ejercicios_seleccionados:
                # Mostrar resumen
                for i, ej_id in enumerate(st.session_state.ejercicios_seleccionados, 1):
                    ej = next((e for e in ejercicios if e['id'] == ej_id), None)
                    if ej:
                        st.write(f"{i}. {ej.get('titulo', 'Sin t√≠tulo')[:30]}...")
                
                # Botones de acci√≥n
                if st.button("üóëÔ∏è Limpiar Selecci√≥n", use_container_width=True):
                    st.session_state.ejercicios_seleccionados = []
                    st.rerun()
                
                if st.button("üéØ Ir a Generar Documento", type="primary", use_container_width=True):
                    # Pasar ejercicios seleccionados a la p√°gina de generaci√≥n
                    st.session_state.ejercicios_para_documento = st.session_state.ejercicios_seleccionados.copy()
                    st.success("‚úÖ Ejercicios listos para generar documento!")
                    st.info("üëâ Ve a la p√°gina **05_üéØ_Generar_Prueba** para crear tu documento")
            
            else:
                st.info("Selecciona ejercicios de la lista principal")
        
        # √ÅREA PRINCIPAL - RESULTADOS DE B√öSQUEDA
        
        # Aplicar filtros
        ejercicios_filtrados = ejercicios.copy()
        
        # Filtro por unidades
        if unidades_filtro:
            ejercicios_filtrados = [e for e in ejercicios_filtrados 
                                  if e.get('unidad_tematica') in unidades_filtro]
        
        # Filtro por dificultad
        if dificultades_filtro:
            ejercicios_filtrados = [e for e in ejercicios_filtrados 
                                  if e.get('nivel_dificultad') in dificultades_filtro]
        
        # Filtro por modalidad
        if modalidades_filtro:
            ejercicios_filtrados = [e for e in ejercicios_filtrados 
                                  if e.get('modalidad') in modalidades_filtro]
        
        # Filtro por texto
        if texto_busqueda:
            texto_lower = texto_busqueda.lower()
            ejercicios_filtrados = [e for e in ejercicios_filtrados 
                                  if (texto_lower in e.get('titulo', '').lower() or 
                                      texto_lower in e.get('enunciado', '').lower() or
                                      texto_lower in e.get('unidad_tematica', '').lower())]
        
        # Mostrar estad√≠sticas
        col1, col2, col3 = st.columns(3)
        with col1:
            st.metric("üìö Total Disponibles", len(ejercicios))
        with col2:
            st.metric("üîç Filtrados", len(ejercicios_filtrados))
        with col3:
            st.metric("‚úÖ Seleccionados", len(st.session_state.ejercicios_seleccionados))
        
        st.divider()
        
        # LISTA DE EJERCICIOS CON SELECCI√ìN
        if ejercicios_filtrados:
            st.subheader(f"üìã Ejercicios Encontrados ({len(ejercicios_filtrados)})")
            
            # Opci√≥n de seleccionar todos los filtrados
            col1, col2 = st.columns([3, 1])
            with col2:
                if st.button("‚úÖ Seleccionar Todos los Filtrados"):
                    for ej in ejercicios_filtrados:
                        if ej['id'] not in st.session_state.ejercicios_seleccionados:
                            st.session_state.ejercicios_seleccionados.append(ej['id'])
                    st.rerun()
            
            # Mostrar ejercicios con checkboxes
            for ejercicio in ejercicios_filtrados:
                mostrar_ejercicio_con_seleccion(ejercicio)
                
        else:
            st.warning("üîç No se encontraron ejercicios con los filtros aplicados")
            if unidades_filtro or dificultades_filtro or modalidades_filtro or texto_busqueda:
                st.info("üí° Intenta reducir los filtros o cambiar los t√©rminos de b√∫squeda")
    
    except Exception as e:
        st.error(f"Error: {str(e)}")
        import traceback
        st.code(traceback.format_exc())

def mostrar_ejercicio_con_seleccion(ejercicio):
    """Muestra un ejercicio con opci√≥n de selecci√≥n"""
    
    # Container para el ejercicio
    with st.container():
        col_check, col_content = st.columns([0.1, 0.9])
        
        # Checkbox de selecci√≥n
        with col_check:
            ejercicio_seleccionado = st.checkbox(
                "",
                value=ejercicio['id'] in st.session_state.ejercicios_seleccionados,
                key=f"check_{ejercicio['id']}",
                help="Seleccionar para documento"
            )
            
            # Actualizar estado de selecci√≥n
            if ejercicio_seleccionado:
                if ejercicio['id'] not in st.session_state.ejercicios_seleccionados:
                    st.session_state.ejercicios_seleccionados.append(ejercicio['id'])
            else:
                if ejercicio['id'] in st.session_state.ejercicios_seleccionados:
                    st.session_state.ejercicios_seleccionados.remove(ejercicio['id'])
        
        # Contenido del ejercicio
        with col_content:
            # Header con t√≠tulo y metadatos
            col_title, col_meta = st.columns([2, 1])
            
            with col_title:
                st.markdown(f"### {ejercicio.get('titulo', 'Sin t√≠tulo')}")
            
            with col_meta:
                # Badges de informaci√≥n
                if ejercicio.get('unidad_tematica'):
                    st.markdown(f"üéØ **{ejercicio['unidad_tematica']}**")
                if ejercicio.get('nivel_dificultad'):
                    color = {"B√°sico": "green", "Intermedio": "orange", "Avanzado": "red", "Desaf√≠o": "purple"}.get(ejercicio['nivel_dificultad'], "blue")
                    st.markdown(f":{color}[üéöÔ∏è {ejercicio['nivel_dificultad']}]")
                if ejercicio.get('tiempo_estimado'):
                    st.markdown(f"‚è±Ô∏è **{ejercicio['tiempo_estimado']} min**")
            
            # Enunciado (preview)
            if ejercicio.get('enunciado'):
                enunciado_preview = ejercicio['enunciado'][:200]
                if len(ejercicio['enunciado']) > 200:
                    enunciado_preview += "..."
                st.write(enunciado_preview)
            
            # Informaci√≥n adicional en expander
            with st.expander("üëÅÔ∏è Ver detalles completos"):
                # Enunciado completo
                if ejercicio.get('enunciado'):
                    st.write("**Enunciado completo:**")
                    st.write(ejercicio['enunciado'])
                
                # Datos de entrada
                if ejercicio.get('datos_entrada'):
                    st.write("**Datos:**")
                    st.write(ejercicio['datos_entrada'])
                
                # Soluci√≥n
                if ejercicio.get('solucion_completa'):
                    st.write("**Soluci√≥n:**")
                    st.write(ejercicio['solucion_completa'])
                
                # C√≥digo Python
                if ejercicio.get('codigo_python'):
                    st.write("**C√≥digo Python:**")
                    st.code(ejercicio['codigo_python'], language='python')
                
                # Metadatos adicionales
                col1, col2 = st.columns(2)
                with col1:
                    if ejercicio.get('modalidad'):
                        st.write(f"**Modalidad:** {ejercicio['modalidad']}")
                    if ejercicio.get('fuente'):
                        st.write(f"**Fuente:** {ejercicio['fuente']}")
                
                with col2:
                    if ejercicio.get('fecha_creacion'):
                        fecha = ejercicio['fecha_creacion'][:10] if len(ejercicio['fecha_creacion']) > 10 else ejercicio['fecha_creacion']
                        st.write(f"**Creado:** {fecha}")
                    st.write(f"**ID:** {ejercicio['id']}")
        
        st.divider()

if __name__ == "__main__":
    main()